
{% extends "home.html" %}

{%block main %}
    <div class="row">
        <div class="span1"></div>
    </div>
    
    <form class="form-horizontal">
	<div class="control-group">
	    <label class="control-label">Name</label>
	    <div class="controls">
		<input class="input-xxlarge required" type="text" name="name" placeholder="New Task">
	    </div>
	</div>
	 <div class="control-group">
	    <label class="control-label"> Description
	    </label>
	    <div class="controls"> 
		<textarea rows="5" class="required input-xxlarge" placeholder="Describe what a housemate should do in order to complete the task." name="desc"></textarea>
	    </div>
	</div>
         
        <div class="control-group">
	    <label class="control-label"> Points
	    </label>
	    <div class="controls">
                <div class="dropdown" style="display: inline;">
                    <div class="input-append dropdown-toggle" data-toggle="dropdown" data-target="#">
                        <input type="text" name="points" class="required number input-small" placeholder="How many?">
                        <span class="add-on tt-right" title="Suggestions"><i class="icon-list-alt"></i></span>
                    </div>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                        <li><a href="#" data-points="1000">Paying rent {{points_helper.points(1000)}}</a></li>
                        <li class="dropdown-submenu"><a href="#">Cleaning</a>
                            <ul class="dropdown-menu">
                                <li> <a href="#" data-points="200">Cleaning the bathroom {{points_helper.points(200)}}</a></li>
                                <li> <a href="#" data-points="200">Vacuuming {{points_helper.points(150)}}</a></li>
                                <li> <a href="#" data-points="200">Cleaning the kitchen {{points_helper.points(175)}}</a></li>
                            </ul>
                        </li>
                        <li class="dropdown-submenu"><a href="#">Other jobs</a>
                            <ul class="dropdown-menu">
                                <li> <a href="#" data-points="200">Putting the rubbish bins out{{points_helper.points(200)}}</a></li>
                                <li> <a href="#" data-points="100">Taking out the recycling {{points_helper.points(100)}}</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
	</div>
	<div class="control-group">
	    <label class="control-label"> Due date
	    </label>
	    <div class="controls">
		<div class="input-append">
		    <input id="when" class="input-xlarge required" type="text" name="start_date" placeholder="eg: saturday, tomorrow, next wed">
		    <span id="cal-icon" data-date-format="dd-mm-yyyy" class="add-on"><i class="icon-calendar"></i></span>
		</div>
		<span id="date-info" class="inline-help"></span>
	    </div>
	</div>
	
        
	<div id="reminder-details">
	    <div class="control-group" id="reminder-options">
		<label class="control-label"> Reminder(s)
		</label>
		<div class="controls"> 
		    <select class="required" name="reminders">
			<optgroup label="Same day">
			    <option>That afternoon (about 2pm)</option>
			    <option>Lunch time (about 12pm)</option>
			    <option>That morning (about 10am)</option>
			</optgroup>
			<optgroup label="The day before">
			    <option>The night before (about 7pm)</option>
			    <option>The evening before (about 5pm)</option>
			    <option>The afternoon before (about 3pm)</option>
			    <option selected>Anytime the day before</option>
			</optgroup>
			<optgroup label="A few days before">
			    <option>2 days before</option>
			    <option>3 days before</option>
			    <option>5 days before</option>
			    <option>7 days before</option>
			    <option>10 days before</option>
			    <option>14 days before</option>
			</optgroup>
		    </select>
		    <span id="date-info" class="inline-help"></span>
		    <i id="add_reminder" class="icon-plus tt-right" title="add another reminder"></i>
		    <i id="rem_reminder" class="icon-minus"></i>
		</div>
	    </div>
	</div>
	
        
	<div class="control-group">
	    <label class="control-label"> Options
	    </label>
	    <div class="controls">
		<label class="checkbox inline">
		    <input type="checkbox" id="repeats_cb" name="repeat" value="True"> Repeat
		</label>
		<label class="checkbox inline pop-below" data-title="Shared tasks" data-content="Normally a task can only be completed by one housemate; some tasks (like rent)  however need to be completed by multiple housemates before they are actually completed.">
		    <input type="checkbox" id="shared_task_cb" name='shared_task' value="True"> Shared
		</label>
                <label class="checkbox inline pop-below" data-title="Task expiry" data-content="Normally a task expires at the end of the day it is due (it can no longer be completed nor points claimed). If you wan't tasks to be valid after their due date, check this box." >
		    <input type="checkbox" id="expires_cb" name="doesnt_expire" value="True"> No expiry
		</label>
		<label class="checkbox inline pop-below" data-title="Reminders" data-content="Reminders are sent to housemates before a task expires. For shared tasks, housemates who have completed the task already will not receive futher reminders.">
		    <input type="checkbox" id="reminder_cb" name="no_reminder" value="True"> No reminders
		</label>
	    </div>
	</div>
	
	<div id="repeat-options">
            <hr>
	    <div class="control-group">
		<label class="control-label">Repeats
		</label>
		<div class="controls">
		    <select class="required span2" name="repeat_period">
			<option value="Daily">Daily</option>
			<option value="Weekly" selected>Weekly</option>
			<option value="Monthly">Monthly</option>
			<option value="Yearly">Yearly</option>
		    </select>
		</div>
	    </div>
    
	    <div class="control-group">
		<label class="control-label">Repeat every
		</label>
		<div class="controls">
		    <select class="required span1" name="repeat_freq">{%  for number in range(1,31) %}
			<option value="{{ number }}">{{number}}</option>{% endfor %}
		    </select> <span class="inline-help" id="freq-desc">weeks</span>
		</div>
	    </div>
	    
	    <div class="control-group" id="weekdays">
		<label class="control-label">Repeat on
		</label>
		<div class="controls">
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="Monday"> Mon</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="Tuesday"> Tue</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="Wednesday"> Wed</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="Thursday"> Thu</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="Friday"> Fri</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="Saturday"> Sat</label>
                    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="Sunday"> Sun</label>
		</div>
	    </div>
	    
	    <div class="control-group" id="monthday">
		<label class="control-label">Repeat by
		</label>
		<div class="controls">
		    <label class="radio inline"><input type="radio" class="required" name="repeat_by" value="dom"> day of the month</label>
		    <label class="radio inline"><input type="radio" name="repeat_by" value="dow"> day of the week</label>
		</div>
	    </div>
            <div class="control-group">
                <label class="control-label">Repeat
                </label>
                <div class="controls" id="repeat-times">
                    <label class="radio"><input type="radio" name="repeats_limited" value="False" checked> until cancelled</label>
                    <label class="radio"><input id='repeat-times-check' type="radio" name="repeats_limited" value="True">
                    <input type="text" id="repeat-times-input" class="number input-mini" name="repeats_times">
                    occurences </label>
                </div>
            </div>
	</div>
        
        <div id="shared-options">
            <hr>
             <div class="control-group">
                <label class="control-label"> How many?
                </label>
                <div class="controls" id="shared-num">
                    <label class="radio"><input type="radio" name="shared_all_reqd" value="True" checked> All housemates</label>
                    <label class="radio"><input id="shared-num-check" type="radio" name="shared_all_reqd" value="False">
                    <input type="text" id="shared-num-input" class="number input-mini" name="shared_number">
                    housemates </label>
                </div>
            </div>
        </div>
	
	
	
	<div class="control-group">
	    <div class="controls">
		
		<button type="submit" class="btn btn-success">Create task &raquo;</button>
	    </div>
	</div>
    </form>
    <script src="/js/vendor/bootstrap-datepicker.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/css/datepicker.css">
    <script src="/js/vendor/datejs/date.js" type="text/javascript"></script>
    <script src="/js/vendor/jquery-validate/jquery.validate.min.js"></script>
    <script>
    
	$('form input:first').focus();
        
        $('.dropdown-menu a').click(function(){
            $('input[name=points]').val($(this).data('points')).keyup();
            //$(this).parents('.dropdown-menu').dropdown('toggle');
            $('.dropdown.open .dropdown-toggle').dropdown('toggle');
        });
        
        $('input[name=points]').click(function(e){
            e.preventDefault();
            return false;
        });
	
	$('.tt-right').tooltip( {
	    placement: 'right'
	});
        
        $('.pop-below').popover({
            placement: 'bottom',
            trigger: 'hover',
            delay: { show: 200, hide: 300 }
        });
        
        $('.pop-right').popover({
            placement: 'right',
            trigger: 'hover',
            delay: {show : 200, hide:0}
        });
        
        function override_validate(remove,add) {
            $('#when').removeClass(remove).addClass(add);
            $('#when').parent().parent().parent().removeClass(remove).addClass(add);
        }
	
	$('#when').bind('keyup',function() {
	    
	    var messages = ["Nope", "Keep Trying", "Nadda", "Sorry", "No one\'s home", "Arg", "Bummer", "Faux pas", "Whoops", "Snafu", "Blunder"];
	    
	    p = Date.parse($('#when').val());
	    $('#date-info').remove();
			   
	    if (p == null) {
		$('<span id="date-info" class="inline-help"> <i class="icon-exclamation-sign"></i> ' +
		    messages[Math.round(messages.length * Math.random())] + "..." +
		  '</span>')
		    .insertAfter($('#when').parent());
		    
		    setTimeout(override_validate,5,'success','error');
		    
	    } else {
		    $('<span id="date-info" class="inline-help"> <i class="icon-ok"></i> ' +
		    p.toString("dddd dd MMMM, yyyy") +
		  '</span>')
		    .insertAfter($('#when').parent());
	    }
	});
	
	$('#when').live('blur',function() {
	    var di = $('#date-info');
	   
	    if (di != null) {
		if (di.children('i').hasClass('icon-ok')) {
		    $('#when').val($.trim(di.text()));
		    $('#when').removeClass('error').addClass("success");
		    di.remove();
		} else {
                    setTimeout(override_validate,5,'success','error');
                }
 	    }
	    
	});
	
	$('#cal-icon').attr('data-date',Date.today().toString('dd/MM/yyyy') );
	
	$('#cal-icon').datepicker()
	    .on('changeDate', function(ev){
		    $('#when').val(ev.date.toString('dddd dd MMMM, yyyy'));
		    $('#date-info :last').remove();
                    setTimeout(override_validate,5,'error','success');
                    $('.datepicker').hide();
		    //startDate = new Date(ev.date);
		    //$('#startDate').text($('#dp4').data('date'));
		
	    });
	    
	function checked(cb){
	    return $(cb).attr("checked") != "undefined" && $(cb).attr("checked") == "checked"
	}
        
        $('#repeat-times').change(function() {
            if (checked($('#repeat-times-check')) ){
                $('#repeat-times-input').addClass('required').addClass('number')
                .parent().parent().parent().removeClass('error').removeClass('success');
            } else {
                $('#repeat-times-input').removeClass('required').removeClass('error').val('')
                .parent().parent().parent().removeClass('error').removeClass('success').find('.inline-help').remove();
            }
        });
        
        $('#shared-num').change(function() {
            if (checked($('#shared-num-check')) ){
                $('#shared-num-input').addClass('required').addClass('number')
                .parent().parent().parent().removeClass('error').removeClass('success');
            } else {
                $('#shared-num-input').removeClass('required').removeClass('error').val('')
                .parent().parent().parent().removeClass('error').removeClass('success').find('.inline-help').remove();
            }
        });
        
	$('#repeats_cb').change(function() {
	    if (checked(this)) {
		$('#repeat-options').show();
	    } else {
		$('#repeat-options').hide();
	    }
	});

	$('select[name=repeat_period]').change(function() {
	    $('#freq-desc').parent().parent().show();
	    $('#weekdays').hide();
	    $('#monthday').hide();
	    switch($(this).val()) {
		case 'Daily':
		    $('#freq-desc').text('days');
		    break;
		case 'Weekly':
		    $('#freq-desc').text('weeks');
		    $('#weekdays').show();
		    break;
		case 'Monthly':
		    $('#freq-desc').text('months');
		    $('#monthday').show();
		    break;
		case 'Yearly':
		    $('#freq-desc').parent().parent().hide();
		    break;	
	    }
	});
        
        
        $('#shared_task_cb').change(function(){
            if (checked(this)) {
              $('#shared-options').show();  
            } else {
                $('#shared-options').hide();
            }
        });
	
	//Defaults to weekly with reminder
	$('select[name=repeat_period]').val('Daily').change();
	//$('#repeat-options').hide();
	$('#repeats_cb').attr('checked',null).change();
	$('#shared_task_cb').attr('checked',null).change();
        
	$('#rem_reminder').hide();
	
	$('#add_reminder').click(function(){
            if ($('div[id=reminder-options]').length > 9) {
                alert("Sorry, there is a maximum of 10 reminders allowed.");
            } else {
                var ro  = $('#reminder-options :first').clone().insertAfter('#reminder-options :last');
                $(ro).children('.control-label').remove();
                $(ro).find('#add_reminder').remove();
                $(ro).find('#rem_reminder').show();
            }
	});
	
	$('#rem_reminder').live('click',function() {
	   $(this).parent().parent().remove();
	});
	
	$('#reminder_cb').change(function(){
	
	    if (checked(this)) {
		$('#reminder-details').hide();
	    }else {
		$('#reminder-details').show();
	    }
	    
	});
        
    
	
	$('form').validate({
	    errorElement: "span",
	    validClass: "success",
	    errorPlacement: function(error, element) {
		var cg = $(element).parents('.control-group').removeClass('success').addClass("error");
		$(error).appendTo( cg.children('.controls') ).addClass('inline-help');
	    },
	    success: function(label) {
		$(label).parent().closest('.control-group').removeClass('error').addClass('success');
		$(label).remove();
	    },
	    invalidHandler : function(form,validator) {
		var alert = $('<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">×</button>' +
		    'Please correct the errors above.</div>').insertAfter($(this)).fadeIn('slow');
		    
		setTimeout(function(){
		    $(alert).fadeOut('slow');
		},2000);
	    },						   
	    submitHandler: function(form) {
		post_form('/task/create',form,$('form'));
	    }
    });
	
    </script>
        
        
 {%endblock%}