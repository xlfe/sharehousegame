
{% extends "home.html" %}

{%block main %}
    <div class="row">
        <div class="span1"></div>
    </div>

    <div class="row">
        <div class="span5 "><h3>Tasks</h3>    </div>
    </div>
    
    
    <form class="form-horizontal">
	<input id="tz-hidden" type="text" name="timezone">
	<div class="control-group">
	    <label class="control-label">Name</label>
	    <div class="controls">
		<input class="input-xxlarge required" type="text" name="task_name" placeholder="Untitled">
	    </div>
	</div>
	
	<div class="control-group">
	    <label class="control-label">Date
	    </label>
	    <div class="controls">
		<div class="input-append">
		    <input id="when" class="input-xlarge required" type="text" name="task_date" placeholder="eg: saturday, tomorrow, next wed">
		    <span id="cal-icon" data-date-format="dd-mm-yyyy" class="add-on"><i class="icon-calendar"></i></span>
		</div>
		<span id="date-info" class="inline-help"></span>
	    </div>
	</div>
	
	<div class="control-group">
	    <label class="control-label">
	    </label>
	    <div class="controls">
		<label class="checkbox inline">
		    <input type="checkbox" id="repeats_cb" name="repeat" value="as_specified"> Repeat
		</label>
		<label class="checkbox inline tt-hover" title="All housemates must complete the task before it is considered 'done' - for example, paying rent.">
		    <input type="checkbox" id="group_task_cb" value="group_task"> Group task
		</label>
		<label class="checkbox inline">
		    <input type="checkbox" id="reminder_cb" name="reminder" value="dont_send"> Don't send reminder
		</label>
	    </div>
	</div>
	
	<div id="repeat-options">
	    <div class="control-group">
		<label class="control-label">Repeats
		</label>
		<div class="controls">
		    <select class="required span2" name="repeat-period">
			<option value="Daily">Daily</option>
			<option value="Weekly" selected>Weekly</option>
			<option value="Monthly">Monthly</option>
			<option value="Yearly">Yearly</option>
		    </select>
		</div>
	    </div>
    
	    <div class="control-group">
		<label class="control-label">Repeat every
		</label>
		<div class="controls">
		    <select class="required span1" name="repeat-freq">{%  for number in range(1,31) %}
			<option value="{{ number }}">{{number}}</option>{% endfor %}
		    </select> <span class="inline-help" id="freq-desc">weeks</span>
		</div>
	    </div>
	    
	    <div class="control-group" id="weekdays">
		<label class="control-label">Repeat on
		</label>
		<div class="controls">
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="sunday"> S</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="monday"> M</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="tuesday"> T</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="wednesday"> W</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="thursday"> T</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="friday"> F</label>
		    <label class="checkbox inline"><input type="checkbox" name="repeat_on" value="saturday"> S</label>
		</div>
	    </div>
	    
	    <div class="control-group" id="monthday">
		<label class="control-label">Repeat by
		</label>
		<div class="controls">
		    <label class="radio inline"><input type="radio" class="required" name="repeat-by" value="dom"> day of the month</label>
		    <label class="radio inline"><input type="radio" name="repeat-by" value="dow"> day of the week</label>
		</div>
	    </div>
	</div>
	
	<div id="reminder-details">
	    <div class="control-group" id="reminder-options">
		<label class="control-label">Send a reminder
		</label>
		<div class="controls"> 
		    <select class="required" name="reminder">
			<optgroup label="Same day">
			    <option>That afternoon (about 2pm)</option>
			    <option>Lunch time (about 12pm)</option>
			    <option>That morning (about 10am)</option>
			</optgroup>
			<optgroup label="The day before">
			    <option>The night before (about 7pm)</option>
			    <option>The evening before (about 5pm)</option>
			    <option>The afternoon before (about 3pm)</option>
			    <option selected>Anytime the day before</option>
			</optgroup>
			<optgroup label="A few days before">
			    <option>2 days before</option>
			    <option>3 days before</option>
			    <option>5 days before</option>
			    <option>7 days before</option>
			    <option>10 days before</option>
			    <option>14 days before</option>
			</optgroup>
		    </select>
		    <span id="date-info" class="inline-help"></span>
		    <i id="add_reminder" class="icon-plus tt-right" title="add another reminder"></i>
		    <i id="rem_reminder" class="icon-minus"></i>
		</div>
	    </div>
	</div>
	
	 <div class="control-group">
	    <label class="control-label">Task description
	    </label>
	    <div class="controls"> 
		<textarea rows="3" class="required" name="task_desc"></textarea>
	    </div>
	</div>
	
	<div class="control-group">
	    <div class="controls">
		
		<button type="submit" class="btn btn-success">Create task &raquo;</button>
	    </div>
	</div>
    </form>
    <script src="/js/vendor/bootstrap-datepicker.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/css/datepicker.css">
    <script src="/js/vendor/datejs/date.js" type="text/javascript"></script>
    <script src="/js/vendor/jstz.min.js" type="text/javascript"></script>
    <script src="/js/vendor/jquery-validate/jquery.validate.min.js"></script>
    <script>
	var timezone = jstz.determine();
	$('#tz-hidden').val(timezone.name()).hide();
    
	$('form input:first').focus();
	
	$('.tt-hover').tooltip({
	    placement:'bottom'
	});
	
	$('.tt-right').tooltip( {
	    placement: 'right'
	})
	
	$('#when').bind('keyup',function() {
	    
	    var messages = ["Nope", "Keep Trying", "Nadda", "Sorry", "No one\'s home", "Arg", "Bummer", "Faux pas", "Whoops", "Snafu", "Blunder"];
	    
	    p = Date.parse($('#when').val());
	    $('#date-info').remove();
			   
	    if (p == null) {
		$('<span id="date-info" class="inline-help"> <i class="icon-exclamation-sign"></i> ' +
		    messages[Math.round(messages.length * Math.random())] + "..." +
		  '</span>')
		    .insertAfter($('#when').parent());
		    
		    setTimeout(function(){
			$('#when').removeClass('success').addClass('error');
			$('#when').parent().parent().parent().removeClass('success').addClass('error');
		    },5);
		    
	    } else {
		    $('<span id="date-info" class="inline-help"> <i class="icon-ok"></i> ' +
		    p.toString("dddd dd MMMM, yyyy") +
		  '</span>')
		    .insertAfter($('#when').parent());
	    }
	});
	
	$('#when').live('blur',function() {
	    var di = $('#date-info');
	   
	    if (di != null) {
		if (di.children('i').hasClass('icon-ok')) {
		    $('#when').val($.trim(di.text()));
		    $('#when').removeClass('error').addClass("success");
		    di.remove();
		}
	    }
	    
	});
	
	$('#cal-icon').attr('data-date',Date.today().toString('dd/MM/yyyy') );
	
	$('#cal-icon').datepicker()
	    .on('changeDate', function(ev){
		    $('#when').val(ev.date.toString('dddd dd MMMM, yyyy'));
		    $('#date-info :last').remove();
		    //startDate = new Date(ev.date);
		    //$('#startDate').text($('#dp4').data('date'));
		
	    });
	    
	function checked(cb){
	    return $(cb).attr("checked") != "undefined" && $(cb).attr("checked") == "checked"
	}
	$('#repeats_cb').change(function() {
	    if (checked(this)) {
		$('#repeat-options').show();
	    } else {
		$('#repeat-options').hide();
	    }
	});

	$('select[name=repeat-period]').change(function() {
	    $('#freq-desc').parent().parent().show();
	    $('#weekdays').hide();
	    $('#monthday').hide();
	    switch($(this).val()) {
		case 'Daily':
		    $('#freq-desc').text('days');
		    break;
		case 'Weekly':
		    $('#freq-desc').text('weeks');
		    $('#weekdays').show();
		    break;
		case 'Monthly':
		    $('#freq-desc').text('months');
		    $('#monthday').show();
		    break;
		case 'Yearly':
		    $('#freq-desc').parent().parent().hide();
		    break;	
	    }
	});
	
	//Defaults to weekly with reminder
	$('select[name=repeat-period]').val('Daily').change();
	//$('#repeat-options').hide();
	$('#repeats_cb').attr('checked',null).change();
	
	$('#rem_reminder').hide();
	
	$('#add_reminder').click(function(){
	    var ro  = $('#reminder-options :first').clone().insertAfter('#reminder-options :last');
	    $(ro).children('.control-label').remove();
	    $(ro).find('#add_reminder').remove();
	    $(ro).find('#rem_reminder').show();
	});
	
	$('#rem_reminder').live('click',function() {
	   $(this).parent().parent().remove();
	});
	
	$('#reminder_cb').change(function(){
	
	    if (checked(this)) {
		$('#reminder-details').hide();
	    }else {
		$('#reminder-details').show();
	    }
	    
	});
    
	
	$('form').validate({
	    errorElement: "span",
	    validClass: "success",
	    errorPlacement: function(error, element) {
		$(element).closest('.control-group').removeClass('success').addClass("error");
		$(error).appendTo( element.parent() ).addClass('inline-help');
	    },
	    success: function(label) {
		$(label).parent().closest('.control-group').removeClass('error').addClass('success');
		$(label).remove();
	    },
	    invalidHandler : function(form,validator) {
		var alert = $('<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">Ã—</button>' +
		    'Please correct the errors above.</div>').insertAfter($(this)).fadeIn('slow');
		    
		setTimeout(function(){
		    $(alert).fadeOut('slow');
		},2000);
	    },						   
	    submitHandler: function(form) {
		post_form('/task/create',form,this);
	    }
    });
	
    </script>
        
        
 {%endblock%}