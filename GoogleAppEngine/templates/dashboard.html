
{% extends "home.html" %}

{%block main %}
    <div class="row">
        <div class="span1"></div>
    </div>


    <div class="row span8">
        <table class="table table-hover">
            <tbody>
            {% for u in house.get_users() %}
                <tr>
                    <td>{{u.get_first_name()}}</td>
                    <td>{{ points_helper.points(u.points_balance())}}</td>
                    <td></td>
                </tr>
            {%endfor%}

            {% set i = 0 %}
                {% for u in house.invited_users %}
                <tr>
                    <td>{{u.name}}</td>
                    <td>Hasn't joined the game yet {% if u.elapsed() %}
                            <button class="btn btn-mini btn-info" id="invite-reminder" name="{{i}}">Resend invite <i class="icon-envelope"></i></button>{%endif%}
                    </td>   {%set i = i+1 %}
                    <td></td>
                </tr>
                {%endfor%}

                <tr>
                    <td id="add-housemate" colspan="100" align="center"> <i class="icon-plus"></i> Add a housemate</td></a>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="row span8">
        <h4>Recent activity</h4>
         <table class="table table-hover">
            <tbody>
                {% for a in house.recent_activity() %}
                <tr>
                    <td>{{ points_helper.points(a.points) }} {{a.who}} {{a.desc}}</td>
                    <td>{{a.when}}</td>
                    <td></td>
                </tr>
                {%endfor%}
            </tbody>
        </table>
    </div>

    <script>

    $('#add-housemate').live('click','',function() {
        var element = $('<tr><td><input class="input input-low required" placeholder="Name" name="name" type="text"></td>' +
                '<td><input class="input input-low required email" placeholder="Email address" name="email" type="text"></td>' +
                '<td><button id="add-hm-btn" class="btn btn-success btn-mini">Add</button></td></tr>')
                .insertBefore($(this).parents('tr'));


    });

    $('#add-hm-btn').live('click','',function() {
        var housemate_name = $(this).parent().parent().find('input[name=name]').val();
        var housemate_email = $(this).parent().parent().find('input[name=email]').val();

        $.ajax( {
            type: 'POST',
            url: '/api',
            data: {what:'add_housemate',name:housemate_name,email:housemate_email },
            dataType: "json",
            error: function(reason) {
                alert(reason);
            },
            success:function(response) {
                if (response == null) {
                    alert('Something went wrong, please try again');
                } else {
                    if ("success" in response) {
                        var d = new Date().getTime();
                        document.location.href='/?date='+ d;
                    } else {
                        alert(response['failure']);
                    }
                }
            }

        });

    });
	
	$('#invite-reminder').live('click','',function() {
		$.ajax( {
		    type: 'POST',
		    url: '/api',
		    data: {what:'refer', housemate_id: $(this).attr('name') },
		    dataType: "json",
		
		    error: function(responseText) {
			alert('Something went wrong - please try again!');
		    },
		    success: function(responseText){
		      
		      var response = responseText;// JSON.parse(responseText);
		      var message= null;
		      var timeout = 0;
		      
		      if (response == null) {
			  alert('Something went wrong - please try again!');
		      } else {
		      
			  if ("success" in response) {
				var hm = $('button[name=' + response['success'] +']');
				var label = $('<span class="label label-success">Email sent!</span>').insertAfter($(hm)).fadeIn();
				$(hm).remove();
				
				
			  } else {
			  
				var hm = $('button[name=' + response['hm'] +']');
				var label = $('<span class="label label-info">'+response['failure'] +'</span>').insertAfter($(hm)).fadeIn();
				$(hm).remove();
			  
			  }
			  
			  
			  
			  
		    }
		  }
	    });
	    
	});
	
	
    </script>
        
        
 {%endblock%}