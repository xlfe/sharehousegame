
{% extends "home.html" %}


{%block main %}

    <div id="chart" class="row">
    </div>

    <div class="row">
        <table class="table table-hover">
            <tbody>
            {% for u in house.get_users() %}
                <tr>
                    <td>{{u.get_first_name()}}</td>
                    <td>{{ points_helper.points(u.points_balance())}}</td>
                    <td></td>
                </tr>
            {%endfor%}

            {% set i = 0 %}
                {% for u in house.invited_users %}
                <tr>
                    <td>{{u.name}}</td>
                    <td>Hasn't joined the game yet {% if u.elapsed() %}
                            <button class="btn btn-mini btn-info" id="invite-reminder" name="{{i}}">Resend invite <i class="icon-envelope"></i></button>{%endif%}
                    </td>   {%set i = i+1 %}
                    <td></td>
                </tr>
                {%endfor%}

                <tr>
                    <td id="add-housemate" colspan="100" align="center"> <i class="icon-plus"></i> Add a housemate</td></a>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="row">
        <h4>Recent activity</h4>
         <table class="table table-hover">
            <tbody>
                {% for a in house.recent_activity() %}
                <tr>
                    <td>{{ points_helper.points(a.points) }} {{a.who}} {{a.desc}}</td>
                    <td>{{a.when}}</td>
                    <td></td>
                </tr>
                {%endfor%}
            </tbody>
        </table>
    </div>
    <script src="/js/vendor/d3.v3.min.js"></script>
    <link rel="stylesheet" href="/css/dashboard.css">

    <script>

        var data = [
            {% for u in house.get_users() %}{% for p in u.points_log_json() %}    {{ p|safe }},
            {% endfor %}{% endfor %}];

        var housemates = [{% for u in house.get_users() %}
            {"name":"{{ u.get_first_name() }}","points":{{ u.points_balance() }}},{% endfor %}
        ];

        var margin = {top: 20, right: 80, bottom: 30, left: 50},
                width = 740 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;

        var now = new Date();

        var ticks = {
            'a month ago':d3.time.month.offset(now,-1),
            '3 weeks ago':d3.time.day.offset(now,-21),
            '2 weeks ago':d3.time.day.offset(now,-14),
            '1 week ago' :d3.time.day.offset(now,-7),
            'now':now
        }

        var k = function(v,n) {
            return v[d3.keys(v)[n]];
        }

        var x = d3.time.scale()
                .range([0, width])
                .domain([k(ticks,0),now]);

        var y = d3.scale.linear()
                .nice()
                .range([height, 0]);

        function timeFormat() {
            return function(date) {
                return d3.keys(ticks)[d3.values(ticks).indexOf(date)];
            };
        }

        var ctf = d3.map(ticks).entries();

        var xAxis = d3.svg.axis()
                .scale(x)
                .tickFormat(timeFormat())
                .tickValues(d3.values(ticks))
                .orient("bottom");

        var yAxis = d3.svg.axis()
                .scale(y)
                .orient("right");

        var stack = d3.layout.stack()
                .values(function(d) { return d.values; });

        var area = d3.svg.area()
                .x(function(d) { return x(d.x); })
                .y0(function(d) { return y(d.y0); })
                .y1(function(d) { return y(d.y0 + d.y); });

        var svg = d3.select("#chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var residual_pts = function(initial_pts,hours_elapsed) {
            var decay_const = -5.0;
            var proportion = ( decay_const / initial_pts ) * ( initial_pts - hours_elapsed )
            return Math.round(Math.max(0,initial_pts - Math.exp(proportion) * initial_pts),0)
        };

        var data_pts = {};
        housemates.forEach(function(d) {
            data_pts[d.name] = new Array();
        });

        var hm_color = d3.scale.category10()
            .domain(housemates.map(function(h){
            return h.name;
        }));

        var rp=0;
        data.forEach(function(d) {

            d['values'] = new Array();

            for (var i = 0; i < d.hours_elapsed; i++) {
                rp = residual_pts(d.points, d.hours_elapsed - i);

                if (rp > 0) {
                    d['values'].push({'hours_ago':i,'residual_points':rp});
                }
            }
       });


        y.domain([0,1500]);
       //     d3.max(users, function(c) { return c[1]; });
       // ]);

        svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

        svg.append("g")
                .attr("class", "y axis")
                .attr("transform","translate(" + width + ")")
                .call(yAxis);

        var layers = stack(color.domain().map(function(name){


            return {
                name: name,
                values: data_pts[name][0].values
            };
        }));

        var task = svg.selectAll(".task")
                .data(layers)
                .enter().append("g")
                .attr("class", "task");

        task.append("path")
                .attr("class", "area")
                .attr("d", function(d) { return area(d.values); })
                .style("fill", function(d) { return color(d.who); });

        if (false) {task.append("text")
                .datum(function(d) { return {name: d.name, value: 0}; })
                .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
                .attr("x", 3)
                .attr("dy", ".35em")
                .text(function(d) { return d.name; });
        }

    </script>
    <script>

    $('#add-housemate').live('click','',function() {
        var element = $('<tr><td><input class="input input-low required" placeholder="Name" name="name" type="text"></td>' +
                '<td><input class="input input-low required email" placeholder="Email address" name="email" type="text"></td>' +
                '<td><button id="add-hm-btn" class="btn btn-success btn-mini">Add</button></td></tr>')
                .insertBefore($(this).parents('tr'));


    });

    $('#add-hm-btn').live('click','',function() {
        var housemate_name = $(this).parent().parent().find('input[name=name]').val();
        var housemate_email = $(this).parent().parent().find('input[name=email]').val();

        $.ajax( {
            type: 'POST',
            url: '/api',
            data: {what:'add_housemate',name:housemate_name,email:housemate_email },
            dataType: "json",
            error: function(reason) {
                alert(reason);
            },
            success:function(response) {
                if (response == null) {
                    alert('Something went wrong, please try again');
                } else {
                    if ("success" in response) {
                        var d = new Date().getTime();
                        document.location.href='/?date='+ d;
                    } else {
                        alert(response['failure']);
                    }
                }
            }

        });

    });
	
	$('#invite-reminder').live('click','',function() {
		$.ajax( {
		    type: 'POST',
		    url: '/api',
		    data: {what:'refer', housemate_id: $(this).attr('name') },
		    dataType: "json",
		
		    error: function(responseText) {
			alert('Something went wrong - please try again!');
		    },
		    success: function(responseText){
		      
		      var response = responseText;// JSON.parse(responseText);
		      var message= null;
		      var timeout = 0;
		      
		      if (response == null) {
			  alert('Something went wrong - please try again!');
		      } else {
		      
			  if ("success" in response) {
				var hm = $('button[name=' + response['success'] +']');
				var label = $('<span class="label label-success">Email sent!</span>').insertAfter($(hm)).fadeIn();
				$(hm).remove();
				
				
			  } else {
			  
				var hm = $('button[name=' + response['hm'] +']');
				var label = $('<span class="label label-info">'+response['failure'] +'</span>').insertAfter($(hm)).fadeIn();
				$(hm).remove();
			  
			  }
			  
			  
			  
			  
		    }
		  }
	    });
	    
	});
	
	
    </script>
        
        
 {%endblock%}